<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Oracle</title>

    <script src="./web3.min.js"></script>
    <script src="./ethereumjs-tx-1.3.3.js"></script>


</head>

<body>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <!-- <script src="https://raw.githubusercontent.com/ethereumjs/browser-builds/master/dist/ethereumjs-tx/ethereumjs-tx-1.3.3.min.js"></script> -->
    <script>

        /* if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
            console.log("1");
        } else {

            web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/h6a92a1ApB4XVikUrTOZ"));
            console.log("2");

        } */

        const web3 = new Web3(new Web3.providers.WebsocketProvider('wss://ropsten.infura.io/ws'));

        // web3.eth.defaultAccount = web3.eth.accounts[0];


        var OracleService = new web3.eth.Contract([
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_apiUrl",
                        "type": "string"
                    },
                    {
                        "name": "_pathToData",
                        "type": "string"
                    },
                    {
                        "name": "_sender",
                        "type": "address"
                    }
                ],
                "name": "api_call",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "name": "apiUrl",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "name": "pathToData",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "name": "caller",
                        "type": "address"
                    }
                ],
                "name": "API_call",
                "type": "event"
            }
        ], "0x09826380ce7fd6fe77ec8651cb60c5beb7be972f");

        var OracleClientABI = [
            {
                "constant": false,
                "inputs": [
                    {
                        "name": "_data",
                        "type": "string"
                    }
                ],
                "name": "__callback",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // var oracleServiceContract = OracleService.at("0x09826380ce7fd6fe77ec8651cb60c5beb7be972f");

        Object.byString = function (o, s) {
            s = s.replace(/\[(\w+)\]/g, '.$1');
            s = s.replace(/^\./, '');
            var a = s.split('.');
            for (var i = 0, n = a.length; i < n; ++i) {
                var k = a[i];
                if (k in o) {
                    o = o[k];
                } else {
                    return;
                }
            }
            return o;
        }

        let myAddress = "0x9c21daBc470B1d10AFDBd076C24c70E778A3c5B1";
        let privateKey = "0441829a504f5e1d4194f7494feb6eb2d5819dc0c3204f9fca573aaa8e2a89df";

        var _helper = {
            ensureBuffer: function (bufferOrString) {
                //make sure its a buffer
                if (typeof bufferOrString === "string") {
                    return new Buffer(bufferOrString, 'hex');
                } else {
                    return bufferOrString;
                }
            }
        };

        OracleService.events.API_call({ fromBlock: 0 }, function (err, event) {
            console.log(err);
        }).on('data', (log) => {
            console.log(log);
            let clientContractAddress = log.returnValues.caller;
            let pathToData = log.returnValues.pathToData;
            fetch(log.returnValues.apiUrl)
                .then((resp) => resp.json())
                .then(function (data) {
                    let responseData = Object.byString(data, pathToData);

                    web3.eth.getTransactionCount(myAddress, function (err, nonce) {
                        var data = new web3.eth.Contract(OracleClientABI, clientContractAddress);
                        console.log(data);

                        var tx = {
                            nonce: nonce,
                            gasPrice: web3.utils.toHex(web3.utils.toWei('20', 'gwei')),
                            gasLimit: 1000000,
                            to: clientContractAddress,
                            value: 0,
                            data: data.methods.__callback(responseData)
                        };
                        const transc = new ethereumjs.Tx(tx);
                        transc.sign(_helper.ensureBuffer(privateKey));
                        //transc.sign(ethereumjs.Buffer.Buffer.from(privateKey, 'hex'));

                        var raw = transc.serialize().toString('hex');
                        web3.eth.sendRawTransaction(raw, function (err, transactionHash) {
                            console.log(transactionHash);
                        });
                    });






                    // var oracleClientContract = new web3.eth.Contract(OracleClientABI, clientContractAddress);
                    // let encodedABI = oracleClientContract.methods.__callback(responseData).encodeABI();
                    // let nonce = web3.eth.getTransactionCount(myAddress);
                    // let tx = {
                    //     from: myAddress,
                    //     nonce: nonce,
                    //     gasPrice: web3.utils.toHex(web3.utils.toWei('35', 'gwei')),
                    //     gasLimit: 2000000,
                    //     to: clientContractAddress,
                    //     data: encodedABI
                    // };
                    // let transaction = new ethereumjs.tx(tx.toString('hex'));
                    // transaction.sign(privateKey);
                    // let serializedTx = transaction.serialize().toString('hex');
                    // web3.eth.sendSignedTransaction('0x' + serializedTx, function (err, res) {
                    //     console.log(res);
                    // });
                    /*                         let tran = web3.eth.accounts.signTransaction(tx, privateKey).then((res) => {
                                                web3.eth.sendSignedTransaction(res.rawTransaction).on('receipt', console.log);
                                            }); */

                });

        })

        // var apiCallEvent = oracleServiceContract.API_call();
        // apiCallEvent.watch(function (error, result) {
        //     if (!error) {
        //         let clientContractAddress = result.args.caller;
        //         let pathToData = result.args.pathToData;
        //         fetch(result.args.apiUrl)
        //             .then((resp) => resp.json())
        //             .then(function (data) {
        //                 let responseData = Object.byString(data, pathToData);
        //                 var oracleClientContract = web3.eth.contract(OracleClientABI).at(clientContractAddress);

        //                 web3.eth.getTransactionCount(myAddress, function (err, nonce) {
        //                     let data = oracleClientContract.__callback.getData(responseData);
        //                     var tx = new EthJS.Tx({
        //                         nonce: nonce,
        //                         gasPrice: web3.toHex(web3.toWei("35", "gwei")),
        //                         gasLimit: 1000000,
        //                         to: clientContractAddress,
        //                         value: 0,
        //                         data: data

        //                     });
        //                     tx.sign(EthJS.Buffer.Buffer.from(privateKey, "hex"));
        //                     var raw = "0x" + tx.serialize().toString("hex");
        //                     web3.eth.sendRawTransaction(raw, function (err, txHash) {
        //                         console.log(txHash);
        //                     });
        //                 })
        //             });
        //     } else {
        //         console.log(error);
        //     }
        // });

        //WORKING EXAMPLE: call api_call("http://our-rent-api.herokuapp.com/api/objects", "[0].description");
        //"https://api.coinmarketcap.com/v1/ticker/ethereum/", "[0].price_usd"

    </script>
</body>

</html>